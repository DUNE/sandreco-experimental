add_library(tree_streamer)

target_sources(tree_streamer PRIVATE 
    tree_streamer.hpp
    tree_streamer.cpp)

target_include_directories(tree_streamer PRIVATE . ${CMAKE_SOURCE_DIR}/include)

target_link_libraries(tree_streamer PRIVATE ROOT::RIO ROOT::Tree ufw::ufw)

#The streamer relies on dictionary generation and its own definitions for
#correct representation of any user type. This requires all said types to be known.
#The code below attempts to grab all user types from include/
file(GLOB_RECURSE USER_TYPES
     RELATIVE "${CMAKE_SOURCE_DIR}/include"
     "${CMAKE_SOURCE_DIR}/include/*.hxx"
     "${CMAKE_SOURCE_DIR}/include/*.hpp"
     "${CMAKE_SOURCE_DIR}/include/*.h")

set(USER_TYPES_INCLUDES ${USER_TYPES})
set(COMMENT_NO_EDIT "/* This file is auto generated by cmake: DO NOT EDIT */\n")

#Generate the include file tree_streamer_types.hpp
list(TRANSFORM USER_TYPES_INCLUDES PREPEND "#include <")
list(TRANSFORM USER_TYPES_INCLUDES APPEND ">\n")

file(WRITE tree_streamer_types.hpp ${COMMENT_NO_EDIT})
file(APPEND tree_streamer_types.hpp "#ifndef UFW_IMPLEMENT_STREAMER_FOR_TYPE\n#define UFW_IMPLEMENT_STREAMER_FOR_TYPE(T)\n#endif\n")
file(APPEND tree_streamer_types.hpp "#include <ufw/data.hpp>\n")
file(APPEND tree_streamer_types.hpp ${USER_TYPES_INCLUDES})

#Generate the linkdef file tree_streamer_linkdef.h
set(USER_TYPES_LINKDEF "")
foreach(USER_TYPE_PATH ${USER_TYPES})
  file(STRINGS "${CMAKE_SOURCE_DIR}/include/${USER_TYPE_PATH}" USER_FILE_LINES REGEX "UFW_DECLARE_MANAGED_DATA")
  foreach(LINE ${USER_FILE_LINES})
    string(REGEX MATCH "\\(([^()]*)\\)" _ ${LINE}) 
    list(APPEND USER_TYPES_LINKDEF ${CMAKE_MATCH_1})
  endforeach()
endforeach()

list(TRANSFORM USER_TYPES_LINKDEF PREPEND "#pragma link C++ class ")
list(TRANSFORM USER_TYPES_LINKDEF APPEND "+\;\n")

file(WRITE tree_streamer_linkdef.h ${COMMENT_NO_EDIT})
file(APPEND tree_streamer_linkdef.h "#ifdef __CLING__\n#pragma link off all globals;\n#pragma link off all classes;\n#pragma link off all functions;\n")
file(APPEND tree_streamer_linkdef.h "#pragma link C++ nestedclasses;\n")
file(APPEND tree_streamer_linkdef.h "#pragma link C++ nestedtypedefs;\n")
file(APPEND tree_streamer_linkdef.h "#pragma link C++ class ufw::context_id+;\n")
file(APPEND tree_streamer_linkdef.h "#pragma link C++ class ufw::data::data_base+;\n")
file(APPEND tree_streamer_linkdef.h "#pragma link C++ class ufw::data::managed_tag+;\n")
file(APPEND tree_streamer_linkdef.h "#pragma link C++ class ufw::data::instanced_tag+;\n")
file(APPEND tree_streamer_linkdef.h "#pragma link C++ class ufw::data::context_tag+;\n")
file(APPEND tree_streamer_linkdef.h "#pragma link C++ class ufw::data::base<ufw::data::managed_tag,ufw::data::instanced_tag,ufw::data::context_tag>+;\n")
file(APPEND tree_streamer_linkdef.h "#pragma link C++ class sand::truth+;\n")
file(APPEND tree_streamer_linkdef.h "#pragma link C++ class sand::geo_id+;\n")
file(APPEND tree_streamer_linkdef.h "#pragma link C++ class sand::channel_id+;\n")
file(APPEND tree_streamer_linkdef.h ${USER_TYPES_LINKDEF})
file(APPEND tree_streamer_linkdef.h "#endif\n")

ROOT_GENERATE_DICTIONARY(tree_streamer_dictionaries tree_streamer_types.hpp MODULE tree_streamer LINKDEF tree_streamer_linkdef.h)

install(TARGETS tree_streamer EXPORT sandrecoTargets DESTINATION ${CMAKE_INSTALL_LIBDIR})
install(FILES ${CMAKE_CURRENT_BINARY_DIR}/libtree_streamer_rdict.pcm
        ${CMAKE_CURRENT_BINARY_DIR}/libtree_streamer.rootmap DESTINATION ${CMAKE_INSTALL_LIBDIR})
