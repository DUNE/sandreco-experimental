include(FetchContent)

# Fetch duneanaobj from the 63-skip-cet-option branch
FetchContent_Declare(
  duneanaobj
  GIT_REPOSITORY https://github.com/DUNE/duneanaobj.git
  GIT_TAG        63-skip-cet-option
)
set(SKIP_CET ON CACHE BOOL "Skip CET build system for duneanaobj")
FetchContent_MakeAvailable(duneanaobj)

add_library(caf_streamer)

target_sources(caf_streamer PRIVATE
    caf_streamer.hpp
    caf_streamer.cpp)

target_include_directories(caf_streamer PRIVATE . ${CMAKE_SOURCE_DIR}/include ${duneanaobj_SOURCE_DIR})

target_link_libraries(caf_streamer PRIVATE ROOT::RIO ROOT::Tree ufw::ufw StandardRecord)

include(GNUInstallDirs)
set(DUNEANAOBJ_HEADERS "${duneanaobj_SOURCE_DIR}/duneanaobj/StandardRecord")
#The streamer relies on dictionary generation and its own definitions for
#correct representation of any user type. This requires all said types to be known.
#The code below attempts to grab all user types from include/
#Note: using GLOB instead of GLOB_RECURSE to exclude Proxy/ and Flat/ subdirectories
file(GLOB USER_TYPES
        RELATIVE "${DUNEANAOBJ_HEADERS}"
        "${DUNEANAOBJ_HEADERS}/*.hxx"
        "${DUNEANAOBJ_HEADERS}/*.hpp"
        "${DUNEANAOBJ_HEADERS}/*.h")

set(USER_TYPES_INCLUDES ${USER_TYPES})
set(COMMENT_NO_EDIT "/* This file is auto generated by cmake: DO NOT EDIT */\n")

#Generate the include file caf_streamer_types.hpp
list(TRANSFORM USER_TYPES_INCLUDES PREPEND "#include <duneanaobj/StandardRecord/")
list(TRANSFORM USER_TYPES_INCLUDES APPEND ">\n")

file(WRITE caf_streamer_types.hpp ${COMMENT_NO_EDIT})
file(APPEND caf_streamer_types.hpp ${USER_TYPES_INCLUDES})

#Generate the linkdef file caf_streamer_linkdef.h
set(USER_TYPES_LINKDEF "")
foreach(USER_TYPE_PATH ${USER_TYPES})
  file(STRINGS "${DUNEANAOBJ_HEADERS}/${USER_TYPE_PATH}" USER_FILE_LINES REGEX "(class|struct) +(SR[A-Za-z0-9_]*|StandardRecord|TrueParticleID|FlashMatch)")
  foreach(LINE ${USER_FILE_LINES})
    string(REGEX MATCH "(class|struct) +(SR[A-Za-z0-9_]*|StandardRecord|TrueParticleID|FlashMatch)" _ ${LINE})
    list(APPEND USER_TYPES_LINKDEF ${CMAKE_MATCH_2})
  endforeach()
endforeach()

list(TRANSFORM USER_TYPES_LINKDEF PREPEND "#pragma link C++ class caf::")
list(TRANSFORM USER_TYPES_LINKDEF APPEND "+\;\n")

file(WRITE caf_streamer_linkdef.h ${COMMENT_NO_EDIT})
file(APPEND caf_streamer_linkdef.h "#ifdef __CLING__\n#pragma link off all globals;\n#pragma link off all classes;\n#pragma link off all functions;\n")
file(APPEND caf_streamer_linkdef.h "#pragma link C++ nestedclasses;\n")
file(APPEND caf_streamer_linkdef.h "#pragma link C++ nestedtypedefs;\n")
file(APPEND caf_streamer_linkdef.h ${USER_TYPES_LINKDEF})
file(APPEND caf_streamer_linkdef.h "#endif\n")


include_directories(${duneanaobj_SOURCE_DIR})
ROOT_GENERATE_DICTIONARY(caf_streamer_dictionaries caf_streamer_types.hpp MODULE caf_streamer LINKDEF caf_streamer_linkdef.h)

install(TARGETS caf_streamer EXPORT sandrecoTargets DESTINATION ${CMAKE_INSTALL_LIBDIR})
install(FILES ${CMAKE_CURRENT_BINARY_DIR}/libcaf_streamer_rdict.pcm
        ${CMAKE_CURRENT_BINARY_DIR}/libcaf_streamer.rootmap DESTINATION ${CMAKE_INSTALL_LIBDIR})
