find_package(duneanaobj REQUIRED)

add_library(caf_streamer)

target_sources(caf_streamer PRIVATE 
    caf_streamer.hpp
    caf_streamer.cpp)

target_include_directories(caf_streamer PRIVATE . ${CMAKE_SOURCE_DIR}/include)

target_link_libraries(caf_streamer ROOT::RIO ROOT::Tree ufw::ufw duneanaobj::StandardRecord)

include(GNUInstallDirs)
message("CMAKE_INSTALL_INCLUDEDIR : ${CMAKE_INSTALL_INCLUDEDIR}")
set(DUNEANAOBJ_HEADERS "${CMAKE_INSTALL_PREFIX}/${CMAKE_INSTALL_INCLUDEDIR}/duneanaobj/StandardRecord")
message("DUNEANAOBJ_HEADERS : ${DUNEANAOBJ_HEADERS}")
#The streamer relies on dictionary generation and its own definitions for
#correct representation of any user type. This requires all said types to be known.
#The code below attempts to grab all user types from include/
file(GLOB_RECURSE USER_TYPES
        RELATIVE "${DUNEANAOBJ_HEADERS}"
        "${DUNEANAOBJ_HEADERS}/*.hxx"
        "${DUNEANAOBJ_HEADERS}/*.hpp"
        "${DUNEANAOBJ_HEADERS}/*.h")

message("USER_TYPES : ${USER_TYPES}")

set(USER_TYPES_INCLUDES ${USER_TYPES})
set(COMMENT_NO_EDIT "/* This file is auto generated by cmake: DO NOT EDIT */\n")

#Generate the include file caf_streamer_types.hpp
list(TRANSFORM USER_TYPES_INCLUDES PREPEND "#include <duneanaobj/StandardRecord/")
list(TRANSFORM USER_TYPES_INCLUDES APPEND ">\n")

file(WRITE caf_streamer_types.hpp ${COMMENT_NO_EDIT})
file(APPEND caf_streamer_types.hpp ${USER_TYPES_INCLUDES})


#Generate the linkdef file caf_streamer_linkdef.h
set(USER_TYPES_LINKDEF "")
foreach(USER_TYPE_PATH ${USER_TYPES})
  file(STRINGS "${DUNEANAOBJ_HEADERS}/${USER_TYPE_PATH}" USER_FILE_LINES REGEX "(class|struct) +(SR[A-Za-z0-9_]*)")
  message("USER_FILE_LINES : ${USER_FILE_LINES}")
  foreach(LINE ${USER_FILE_LINES})
    string(REGEX MATCH "(class|struct) +(SR[A-Za-z0-9_]*)" _ ${LINE})
    list(APPEND USER_TYPES_LINKDEF ${CMAKE_MATCH_2})
  endforeach()
endforeach()

message("USER_TYPES_LINKDEF : ${USER_TYPES_LINKDEF}")

list(TRANSFORM USER_TYPES_LINKDEF PREPEND "#pragma link C++ class caf::")
list(TRANSFORM USER_TYPES_LINKDEF APPEND "+\;\n")

file(WRITE caf_streamer_linkdef.h ${COMMENT_NO_EDIT})
file(APPEND caf_streamer_linkdef.h "#ifdef __CLING__\n#pragma link off all globals;\n#pragma link off all classes;\n#pragma link off all functions;\n")
file(APPEND caf_streamer_linkdef.h "#pragma link C++ nestedclasses;\n")
file(APPEND caf_streamer_linkdef.h "#pragma link C++ nestedtypedefs;\n")
file(APPEND caf_streamer_linkdef.h ${USER_TYPES_LINKDEF})
file(APPEND caf_streamer_linkdef.h "#endif\n")


ROOT_GENERATE_DICTIONARY(caf_streamer_dictionaries caf_streamer_types.hpp MODULE caf_streamer LINKDEF caf_streamer_linkdef.h)

install(TARGETS caf_streamer EXPORT sandrecoTargets DESTINATION ${CMAKE_INSTALL_LIBDIR})
install(FILES ${CMAKE_CURRENT_BINARY_DIR}/libcaf_streamer_rdict.pcm
        ${CMAKE_CURRENT_BINARY_DIR}/libcaf_streamer.rootmap DESTINATION ${CMAKE_INSTALL_LIBDIR})
