add_library(TTreeStreamer)

target_sources(TTreeStreamer PRIVATE 
    TFileWrapper.hpp
    TTreeStreamer.hpp
    TTreeStreamer.cpp)

target_include_directories(TTreeStreamer PRIVATE . ${CMAKE_SOURCE_DIR}/include)

target_link_libraries(TTreeStreamer ROOT::RIO ROOT::Tree Boost::log ufw::ufw)

#The streamer relies on dictionary generation and its own definitions for
#correct representation of any user type. This requires all said types to be known.
#The code below attempts to grab all user types from include/
file(GLOB_RECURSE USER_TYPES
     RELATIVE "${CMAKE_SOURCE_DIR}/include"
     "${CMAKE_SOURCE_DIR}/include/*.hxx"
     "${CMAKE_SOURCE_DIR}/include/*.hpp"
     "${CMAKE_SOURCE_DIR}/include/*.h")

set(USER_TYPES_INCLUDES ${USER_TYPES})
set(COMMENT_NO_EDIT "/* This file is auto generated by cmake: DO NOT EDIT */\n")

#Generate the include file TTreeStreamerTypes.hpp
list(TRANSFORM USER_TYPES_INCLUDES PREPEND "#include <")
list(TRANSFORM USER_TYPES_INCLUDES APPEND ">\n")

file(WRITE TTreeStreamerTypes.hpp ${COMMENT_NO_EDIT})
file(APPEND TTreeStreamerTypes.hpp "#ifndef UFW_IMPLEMENT_STREAMER_FOR_TYPE\n#define UFW_IMPLEMENT_STREAMER_FOR_TYPE(T)\n#endif\n")
file(APPEND TTreeStreamerTypes.hpp "#include <data.hpp>\n")
file(APPEND TTreeStreamerTypes.hpp ${USER_TYPES_INCLUDES})

#Generate the linkdef file TTreeStreamerLinkdef.h
set(USER_TYPES_LINKDEF "")
foreach(USER_TYPE_PATH ${USER_TYPES})
  file(STRINGS "${CMAKE_SOURCE_DIR}/include/${USER_TYPE_PATH}" USER_FILE_LINES REGEX "UFW_DECLARE_MANAGED_DATA")
  foreach(LINE ${USER_FILE_LINES})
    string(REGEX MATCH "\\(([^()]*)\\)" _ ${LINE}) 
    list(APPEND USER_TYPES_LINKDEF ${CMAKE_MATCH_1})
  endforeach()
endforeach()

list(TRANSFORM USER_TYPES_LINKDEF PREPEND "#pragma link C++ class ")
list(TRANSFORM USER_TYPES_LINKDEF APPEND "+\;\n")

file(WRITE TTreeStreamerLinkdef.h ${COMMENT_NO_EDIT})
file(APPEND TTreeStreamerLinkdef.h "#ifdef __CLING__\n#pragma link off all globals;\n#pragma link off all classes;\n#pragma link off all functions;\n#pragma link C++ nestedclasses;\n")
file(APPEND TTreeStreamerLinkdef.h "#pragma link C++ class ufw::data::data_base+;\n")
file(APPEND TTreeStreamerLinkdef.h "#pragma link C++ class ufw::data::managed_tag+;\n")
file(APPEND TTreeStreamerLinkdef.h "#pragma link C++ class ufw::data::instanced_tag+;\n")
file(APPEND TTreeStreamerLinkdef.h "#pragma link C++ class ufw::data::context_tag+;\n")
file(APPEND TTreeStreamerLinkdef.h "#pragma link C++ class ufw::data::base<ufw::data::managed_tag,ufw::data::instanced_tag,ufw::data::context_tag>+;\n")
file(APPEND TTreeStreamerLinkdef.h ${USER_TYPES_LINKDEF})
file(APPEND TTreeStreamerLinkdef.h "#endif\n")

ROOT_GENERATE_DICTIONARY(TTreeStreamerDictionaries TTreeStreamerTypes.hpp MODULE TTreeStreamer LINKDEF TTreeStreamerLinkdef.h)

install(TARGETS TTreeStreamer EXPORT sandrecoTargets DESTINATION ${CMAKE_INSTALL_LIBDIR})
