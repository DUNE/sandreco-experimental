//
// Created by paolo on 08/05/2025.
//

#include "fake_reco.hpp"

#include "caf_handlers/interactions.hpp"
#include "caf_handlers/particles.hpp"

#include <edep_reader/edep_reader.hpp>
#include <genie_reader/genie_reader.hpp>

#include <ufw/factory.hpp>

#include <duneanaobj/StandardRecord/StandardRecord.h>

namespace sand::fake_reco {
    fake_reco::fake_reco()
        : process{{}, {}} {
    }

    void fake_reco::configure(const ufw::config &cfg) { process::configure(cfg); }

    void fake_reco::run() {
        // Read input
        const auto &inputTree = get<edep_reader>();
        const auto &genie = get<genie_reader>();

        const auto& event = inputTree.event();

        [[maybe_unused]] std::size_t event_nu_number =
                        event.Primaries.size();
        UFW_DEBUG("Event primaries number: {}", event_nu_number);

        const auto& Particles = event.Primaries[0].Particles;
        for (const auto &particle: Particles) {
            UFW_DEBUG("pdg: {}", particle.GetPDGCode());
        }

        // Just logging some values
        [[maybe_unused]] std::size_t childrenTrajectoriesCount =
                inputTree.GetChildrenTrajectories().size();

        UFW_DEBUG("Reading root trajectory with id: {}", inputTree.GetId());
        UFW_DEBUG("Children trajectories foud: {}", childrenTrajectoriesCount);

        // Create empty interactions
        caf::SRTrueInteraction true_interaction{};
        caf::SRInteraction reco_interaction =
                empty_interaction_from_vertex(inputTree);

        [[maybe_unused]] size_t particle_number = 0;
        // Fill the interactions
        for (const auto &particle: inputTree) {
            // UFW_DEBUG("Parsing particle number {}", particle_number++);

            caf::SRRecoParticle recoParticle =
                    reco_particle_from_edep_trajectory(particle);
            fill_sr_interaction(reco_interaction, recoParticle);

            caf::SRTrueParticle true_particle =
                    true_particle_from_edep_trajectory(particle);
            fill_sr_true_interaction(true_interaction, true_particle);

            // UFW_DEBUG("Children trajectory id: {}", particle.GetId());
            // UFW_DEBUG("Children trajectory PDG code: {}", particle.GetPDGCode());
            // UFW_DEBUG("Interaction number: {}", particle.GetInteractionNumber());
            // UFW_DEBUG("Reaction generated by the child trajectory: {}",
            //           particle.GetReaction());
        }
    }
} // namespace sand::fake_reco

UFW_REGISTER_DYNAMIC_PROCESS_FACTORY(sand::fake_reco::fake_reco);
